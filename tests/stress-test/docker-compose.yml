services:

  http-proxy:
    image: node:18.3
    volumes:
      - ./resources/metrics_filter:/opt/wf/
      - ./resources/certs:/opt/certs/
    ports:
      - "7000:7000"
    working_dir: /opt/wf/
    command: [ "node", "filter.js", "0" ]

  wf-proxy:
    hostname: stress-test-wfproxy
    build: docker/proxy
    # build: docker/proxy-latest
    environment:
      WAVEFRONT_URL: https://${WF_URL}/api/
      WAVEFRONT_TOKEN: ${WF_TOKEN}
      WAVEFRONT_PROXY_ARGS: --proxyHost http-proxy --proxyPort 8000 -f /opt/proxy/proxy.cfg
      JAVA_HEAP_USAGE: 2G
      JVM_USE_CONTAINER_OPTS: false
      JAVA_ARGS: "-Xlog:gc*:file=/var/spool/wavefront-proxy/gc.log"
      TLGF_WF_URL: https://${WF_URL}
    deploy:
      resources:
        limits:
          memory: 4G
    ports:
      - "2878:2878"
    volumes:
      - ./resources/certs:/tmp/ca/
      - ./resources/proxy:/opt/proxy/
      - ./resources/others:/opt/others/
    depends_on:
      - "http-proxy"
    command:
      [
        "/opt/others/wait-for-it.sh",
        "http-proxy:8000",
        "--",
        "/bin/bash",
        "/opt/wavefront/wavefront-proxy/run.sh"
      ]

  jmeter:
    build: docker/jmeter
    volumes:
      - ./resources/jmeter:/opt/jmeter/
      - ./resources/others:/opt/others/
    depends_on:
      - "wf-proxy"
    command:
      [
        "/opt/others/wait-for-it.sh",
        "wf-proxy:2878",
        "--timeout=30",
        "--",
        "jmeter",
        "-n",
        "-t",
        "/opt/jmeter/stress.jmx",
        "-p",
        "/opt/jmeter/stress.properties"
      ]
